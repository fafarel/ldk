<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LDK - Interface Admin Simplifiée</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .admin-header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-icon {
            font-size: 3rem;
            margin-bottom: 15px;
            color: #667eea;
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 1.1rem;
        }

        .data-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .section-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .section-content {
            padding: 20px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 5px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-warning {
            background: #ffc107;
            color: #333;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .data-table th,
        .data-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .data-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .oauth-notice {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }

        .oauth-notice h3 {
            margin-bottom: 10px;
        }

        .oauth-notice a {
            color: #007bff;
            text-decoration: none;
        }

        .oauth-notice a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <!-- Modal d'authentification -->
    <div id="loginModal" class="modal" style="display: block;">
        <div class="modal-content">
            <div class="login-container">
                <h2><i class="fas fa-lock"></i> Accès Administration LDK</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="username">Nom d'utilisateur</label>
                        <input type="text" id="username" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Mot de passe</label>
                        <input type="password" id="password" name="password" required>
                    </div>
                    <button type="submit" class="btn btn-primary">Se connecter</button>
                </form>
                <div id="loginError" class="error-message" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    Identifiants incorrects
                </div>
            </div>
        </div>
    </div>

    <div class="admin-container" id="adminContent" style="display: none;">
        <div class="admin-header">
            <h1><i class="fas fa-cog"></i> Interface d'Administration LDK</h1>
            <p>Gestion des données de l'événement Legendary Dream of Kermess</p>
            <button class="btn btn-warning" onclick="logout()" style="margin-top: 10px;">
                <i class="fas fa-sign-out-alt"></i> Déconnexion
            </button>
        </div>

        <!-- Barre de recherche globale -->
        <div class="search-section">
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="globalSearch" placeholder="Rechercher dans toutes les données..." onkeyup="performGlobalSearch()">
                    <button class="btn btn-secondary" onclick="clearSearch()">
                        <i class="fas fa-times"></i> Effacer
                    </button>
                </div>
                <div class="search-filters">
                    <select id="searchType" onchange="performGlobalSearch()">
                        <option value="all">Tous les types</option>
                        <option value="reservations">Réservations</option>
                        <option value="partenariats">Partenariats</option>
                        <option value="contacts">Contacts</option>
                        <option value="newsletters">Newsletters</option>
                        <option value="visitors">Visiteurs</option>
                    </select>
                    <select id="searchField" onchange="performGlobalSearch()">
                        <option value="all">Tous les champs</option>
                        <option value="nom">Nom</option>
                        <option value="email">Email</option>
                        <option value="telephone">Téléphone</option>
                        <option value="ville">Ville</option>
                        <option value="pays">Pays</option>
                    </select>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>
        </div>

        <div class="oauth-notice">
            <h3><i class="fas fa-info-circle"></i> Note sur Google Sheets</h3>
            <p>L'intégration Google Sheets est temporairement désactivée en raison d'un problème de configuration OAuth.</p>
            <p>Vous pouvez toujours <a href="oauth-fix.html" target="_blank">résoudre le problème</a> ou utiliser les fonctions d'export local.</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-ticket-alt"></i></div>
                <div class="stat-number" id="totalReservations">0</div>
                <div class="stat-label">Réservations</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-handshake"></i></div>
                <div class="stat-number" id="totalPartenariats">0</div>
                <div class="stat-label">Partenariats</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-envelope"></i></div>
                <div class="stat-number" id="totalContacts">0</div>
                <div class="stat-label">Contacts</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-newspaper"></i></div>
                <div class="stat-number" id="totalNewsletters">0</div>
                <div class="stat-label">Newsletters</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-globe"></i></div>
                <div class="stat-number" id="totalVisitors">0</div>
                <div class="stat-label">Visiteurs</div>
            </div>
            <div class="stat-card">
                <div class="stat-icon"><i class="fas fa-map-marker-alt"></i></div>
                <div class="stat-number" id="totalCountries">0</div>
                <div class="stat-label">Pays</div>
            </div>
        </div>

        <div class="data-section">
            <div class="section-header">
                <h3><i class="fas fa-ticket-alt"></i> Réservations</h3>
                <div>
                    <button class="btn btn-primary" onclick="exportData('reservations')">
                        <i class="fas fa-download"></i> Exporter
                    </button>
                    <button class="btn btn-success" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Actualiser
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div id="reservationsData" class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Chargement des données...</p>
                </div>
            </div>
        </div>

        <div class="data-section">
            <div class="section-header">
                <h3><i class="fas fa-handshake"></i> Partenariats</h3>
                <div>
                    <button class="btn btn-primary" onclick="exportData('partenariats')">
                        <i class="fas fa-download"></i> Exporter
                    </button>
                    <button class="btn btn-success" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Actualiser
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div id="partenariatsData" class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Chargement des données...</p>
                </div>
            </div>
        </div>

        <div class="data-section">
            <div class="section-header">
                <h3><i class="fas fa-envelope"></i> Contacts</h3>
                <div>
                    <button class="btn btn-primary" onclick="exportData('contacts')">
                        <i class="fas fa-download"></i> Exporter
                    </button>
                    <button class="btn btn-success" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Actualiser
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div id="contactsData" class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Chargement des données...</p>
                </div>
            </div>
        </div>

        <div class="data-section">
            <div class="section-header">
                <h3><i class="fas fa-newspaper"></i> Newsletters</h3>
                <div>
                    <button class="btn btn-primary" onclick="exportData('newsletters')">
                        <i class="fas fa-download"></i> Exporter
                    </button>
                    <button class="btn btn-success" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Actualiser
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div id="newslettersData" class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Chargement des données...</p>
                </div>
            </div>
        </div>

        <!-- Section Géolocalisation -->
        <div class="data-section">
            <div class="section-header">
                <h3><i class="fas fa-globe"></i> Géolocalisation des Visiteurs</h3>
                <div>
                    <button class="btn btn-primary" onclick="exportData('visitors')">
                        <i class="fas fa-download"></i> Exporter
                    </button>
                    <button class="btn btn-success" onclick="refreshData()">
                        <i class="fas fa-sync"></i> Actualiser
                    </button>
                    <button class="btn btn-warning" onclick="showMapView()">
                        <i class="fas fa-map"></i> Vue Carte
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div id="visitorsData" class="loading">
                    <i class="fas fa-spinner"></i>
                    <p>Chargement des données de géolocalisation...</p>
                </div>
            </div>
        </div>

        <!-- Vue Carte (masquée par défaut) -->
        <div class="data-section" id="mapSection" style="display: none;">
            <div class="section-header">
                <h3><i class="fas fa-map"></i> Carte des Visiteurs</h3>
                <div>
                    <button class="btn btn-secondary" onclick="hideMapView()">
                        <i class="fas fa-table"></i> Vue Tableau
                    </button>
                </div>
            </div>
            <div class="section-content">
                <div id="mapContainer" style="height: 400px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; justify-content: center;">
                    <div style="text-align: center; color: #666;">
                        <i class="fas fa-map-marker-alt" style="font-size: 3rem; margin-bottom: 10px;"></i>
                        <p>Carte des visiteurs</p>
                        <p><small>Fonctionnalité de carte interactive (nécessite une clé API de géolocalisation)</small></p>
                    </div>
                </div>
                <div id="countryStats" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        let currentData = {};
        
        // Configuration d'authentification
        const ADMIN_CREDENTIALS = {
            username: 'admin',
            password: 'ldk2024'
        };

        // Initialisation
        document.addEventListener('DOMContentLoaded', function() {
            if (sessionStorage.getItem('ldk_admin_logged_in') === 'true') {
                showAdminInterface();
            } else {
                showLoginModal();
            }
            
            document.getElementById('loginForm').addEventListener('submit', handleLogin);
        });

        // Gestion de la connexion
        function handleLogin(e) {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('loginError');
            
            if (username === ADMIN_CREDENTIALS.username && password === ADMIN_CREDENTIALS.password) {
                sessionStorage.setItem('ldk_admin_logged_in', 'true');
                showAdminInterface();
                errorDiv.style.display = 'none';
            } else {
                errorDiv.style.display = 'block';
                document.getElementById('password').value = '';
            }
        }

        // Afficher l'interface admin
        function showAdminInterface() {
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('adminContent').style.display = 'block';
            loadAllData();
        }

        // Afficher le modal de connexion
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
            document.getElementById('adminContent').style.display = 'none';
        }

        // Déconnexion
        function logout() {
            if (confirm('Êtes-vous sûr de vouloir vous déconnecter ?')) {
                sessionStorage.removeItem('ldk_admin_logged_in');
                document.getElementById('username').value = '';
                document.getElementById('password').value = '';
                showLoginModal();
            }
        }

        // Chargement des données
        function loadAllData() {
            try {
                let reservations = JSON.parse(localStorage.getItem('ldk_reservations') || '[]');
                
                reservations = reservations.filter(reservation => {
                    return reservation.billetType === 'privilegie' || 
                           reservation.paymentStatus === 'validated' || 
                           reservation.paymentStatus === 'completed' ||
                           reservation.paiementValide === true;
                });
                
                currentData = {
                    reservations: reservations,
                    partenariats: JSON.parse(localStorage.getItem('ldk_partenariats') || '[]'),
                    contacts: JSON.parse(localStorage.getItem('ldk_contacts') || '[]'),
                    newsletters: JSON.parse(localStorage.getItem('ldk_newsletters') || '[]'),
                    visitors: JSON.parse(localStorage.getItem('ldk_visitors') || '[]')
                };
                
                updateStats();
                displayAllData();
                
            } catch (error) {
                console.error('Erreur lors du chargement des données:', error);
            }
        }

        // Affichage des données
        function displayAllData() {
            displayData('reservations');
            displayData('partenariats');
            displayData('contacts');
            displayData('newsletters');
            displayVisitorsData();
        }

        function displayData(type) {
            const container = document.getElementById(type + 'Data');
            const data = currentData[type] || [];
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-inbox"></i>
                        <p>Aucune donnée disponible</p>
                    </div>
                `;
                return;
            }
            
            let html = '<table class="data-table">';
            
            if (type === 'reservations') {
                html += `
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Téléphone</th>
                            <th>Type de billet</th>
                            <th>Âge</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                `;
            } else if (type === 'partenariats') {
                html += `
                    <thead>
                        <tr>
                            <th>Organisation</th>
                            <th>Contact</th>
                            <th>Email</th>
                            <th>Secteur</th>
                            <th>Type</th>
                            <th>Budget</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                `;
            } else if (type === 'contacts') {
                html += `
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Téléphone</th>
                            <th>Sujet</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                `;
            } else if (type === 'newsletters') {
                html += `
                    <thead>
                        <tr>
                            <th>Nom</th>
                            <th>Email</th>
                            <th>Date</th>
                        </tr>
                    </thead>
                `;
            }
            
            html += '<tbody>';
            
            data.forEach(item => {
                const timestamp = item.metadata?.timestamp?.local || new Date().toLocaleString('fr-FR');
                
                if (type === 'reservations') {
                    html += `
                        <tr>
                            <td>${item.nom || 'N/A'}</td>
                            <td>${item.email || 'N/A'}</td>
                            <td>${item.telephone || 'N/A'}</td>
                            <td>${item.billetType || 'N/A'}</td>
                            <td>${item.age || 'N/A'}</td>
                            <td>${timestamp}</td>
                        </tr>
                    `;
                } else if (type === 'partenariats') {
                    html += `
                        <tr>
                            <td>${item.nomOrganisation || 'N/A'}</td>
                            <td>${item.nomContact || 'N/A'}</td>
                            <td>${item.email || 'N/A'}</td>
                            <td>${item.secteur || 'N/A'}</td>
                            <td>${item.typePartenariat || 'N/A'}</td>
                            <td>${item.budget ? item.budget + ' FCFA' : 'N/A'}</td>
                            <td>${timestamp}</td>
                        </tr>
                    `;
                } else if (type === 'contacts') {
                    html += `
                        <tr>
                            <td>${item.nom || 'N/A'}</td>
                            <td>${item.email || 'N/A'}</td>
                            <td>${item.telephone || 'N/A'}</td>
                            <td>${item.sujet || 'N/A'}</td>
                            <td>${timestamp}</td>
                        </tr>
                    `;
                } else if (type === 'newsletters') {
                    html += `
                        <tr>
                            <td>${item.nom || 'N/A'}</td>
                            <td>${item.email || 'N/A'}</td>
                            <td>${timestamp}</td>
                        </tr>
                    `;
                }
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        // Export des données
        function exportData(type) {
            try {
                const data = currentData[type] || [];
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ldk_${type}_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                URL.revokeObjectURL(url);
                
                alert(`${type} exportés avec succès !`);
            } catch (error) {
                console.error('Erreur lors de l\'export:', error);
                alert('Erreur lors de l\'export');
            }
        }

        // Actualisation des données
        function refreshData() {
            loadAllData();
        }

        // Mise à jour des statistiques
        function updateStats() {
            document.getElementById('totalReservations').textContent = currentData.reservations.length;
            document.getElementById('totalPartenariats').textContent = currentData.partenariats.length;
            document.getElementById('totalContacts').textContent = currentData.contacts.length;
            document.getElementById('totalNewsletters').textContent = currentData.newsletters.length;
            document.getElementById('totalVisitors').textContent = currentData.visitors.length;
            
            // Compter les pays uniques
            const countries = [...new Set(currentData.visitors.map(v => v.country).filter(Boolean))];
            document.getElementById('totalCountries').textContent = countries.length;
        }

        // Affichage des données de visiteurs
        function displayVisitorsData() {
            const container = document.getElementById('visitorsData');
            const data = currentData.visitors || [];
            
            if (data.length === 0) {
                container.innerHTML = `
                    <div class="no-data">
                        <i class="fas fa-globe"></i>
                        <p>Aucune donnée de géolocalisation disponible</p>
                        <small>Les visiteurs seront trackés automatiquement</small>
                    </div>
                `;
                return;
            }
            
            // Statistiques par pays
            const countryStats = {};
            data.forEach(visitor => {
                const country = visitor.country || 'Inconnu';
                countryStats[country] = (countryStats[country] || 0) + 1;
            });
            
            // Trier les pays par nombre de visiteurs
            const sortedCountries = Object.entries(countryStats)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 10); // Top 10
            
            let html = '<table class="data-table">';
            html += `
                <thead>
                    <tr>
                        <th>Pays</th>
                        <th>Ville</th>
                        <th>Visiteurs</th>
                        <th>Dernière visite</th>
                        <th>Navigateur</th>
                    </tr>
                </thead>
                <tbody>
            `;
            
            // Afficher les données détaillées
            data.slice(-20).reverse().forEach(visitor => { // 20 derniers visiteurs
                const timestamp = visitor.timestamp || new Date().toLocaleString('fr-FR');
                html += `
                    <tr>
                        <td>${visitor.country || 'N/A'}</td>
                        <td>${visitor.city || 'N/A'}</td>
                        <td>1</td>
                        <td>${timestamp}</td>
                        <td>${visitor.browser || 'N/A'}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            // Ajouter les statistiques par pays
            html += '<div class="geo-stats">';
            html += '<h4><i class="fas fa-chart-bar"></i> Top Pays</h4>';
            html += '<div class="country-list">';
            
            sortedCountries.forEach(([country, count]) => {
                const flag = getCountryFlag(country);
                html += `
                    <div class="country-item">
                        <div style="display: flex; align-items: center;">
                            ${flag ? `<img src="${flag}" class="country-flag" alt="${country}">` : ''}
                            <span class="country-name">${country}</span>
                        </div>
                        <span class="country-count">${count}</span>
                    </div>
                `;
            });
            
            html += '</div></div>';
            container.innerHTML = html;
        }

        // Fonction pour obtenir le drapeau d'un pays
        function getCountryFlag(country) {
            const countryFlags = {
                'France': 'https://flagcdn.com/16x12/fr.png',
                'Côte d\'Ivoire': 'https://flagcdn.com/16x12/ci.png',
                'Ivory Coast': 'https://flagcdn.com/16x12/ci.png',
                'United States': 'https://flagcdn.com/16x12/us.png',
                'Canada': 'https://flagcdn.com/16x12/ca.png',
                'United Kingdom': 'https://flagcdn.com/16x12/gb.png',
                'Germany': 'https://flagcdn.com/16x12/de.png',
                'Spain': 'https://flagcdn.com/16x12/es.png',
                'Italy': 'https://flagcdn.com/16x12/it.png',
                'Netherlands': 'https://flagcdn.com/16x12/nl.png',
                'Belgium': 'https://flagcdn.com/16x12/be.png',
                'Switzerland': 'https://flagcdn.com/16x12/ch.png',
                'Senegal': 'https://flagcdn.com/16x12/sn.png',
                'Mali': 'https://flagcdn.com/16x12/ml.png',
                'Burkina Faso': 'https://flagcdn.com/16x12/bf.png',
                'Niger': 'https://flagcdn.com/16x12/ne.png',
                'Ghana': 'https://flagcdn.com/16x12/gh.png',
                'Nigeria': 'https://flagcdn.com/16x12/ng.png',
                'Cameroon': 'https://flagcdn.com/16x12/cm.png',
                'Gabon': 'https://flagcdn.com/16x12/ga.png',
                'Congo': 'https://flagcdn.com/16x12/cg.png',
                'Morocco': 'https://flagcdn.com/16x12/ma.png',
                'Algeria': 'https://flagcdn.com/16x12/dz.png',
                'Tunisia': 'https://flagcdn.com/16x12/tn.png',
                'Egypt': 'https://flagcdn.com/16x12/eg.png',
                'South Africa': 'https://flagcdn.com/16x12/za.png'
            };
            return countryFlags[country] || null;
        }

        // Recherche globale
        function performGlobalSearch() {
            const searchTerm = document.getElementById('globalSearch').value.toLowerCase().trim();
            const searchType = document.getElementById('searchType').value;
            const searchField = document.getElementById('searchField').value;
            const resultsContainer = document.getElementById('searchResults');
            
            if (searchTerm.length < 2) {
                resultsContainer.style.display = 'none';
                return;
            }
            
            let results = [];
            const searchData = searchType === 'all' ? currentData : { [searchType]: currentData[searchType] || [] };
            
            Object.keys(searchData).forEach(type => {
                const data = searchData[type] || [];
                data.forEach((item, index) => {
                    if (matchesSearch(item, searchTerm, searchField)) {
                        results.push({
                            type: type,
                            item: item,
                            index: index
                        });
                    }
                });
            });
            
            displaySearchResults(results, searchTerm);
        }

        // Vérifier si un élément correspond à la recherche
        function matchesSearch(item, searchTerm, searchField) {
            if (searchField === 'all') {
                // Rechercher dans tous les champs
                const searchableFields = ['nom', 'email', 'telephone', 'ville', 'pays', 'nomOrganisation', 'nomContact', 'sujet', 'billetType'];
                return searchableFields.some(field => {
                    const value = item[field];
                    return value && value.toString().toLowerCase().includes(searchTerm);
                });
            } else {
                // Rechercher dans un champ spécifique
                const value = item[searchField];
                return value && value.toString().toLowerCase().includes(searchTerm);
            }
        }

        // Afficher les résultats de recherche
        function displaySearchResults(results, searchTerm) {
            const resultsContainer = document.getElementById('searchResults');
            
            if (results.length === 0) {
                resultsContainer.innerHTML = '<div class="search-result-item">Aucun résultat trouvé</div>';
                resultsContainer.style.display = 'block';
                return;
            }
            
            let html = '';
            results.slice(0, 10).forEach(result => { // Limiter à 10 résultats
                const typeLabel = {
                    reservations: 'Réservation',
                    partenariats: 'Partenariat',
                    contacts: 'Contact',
                    newsletters: 'Newsletter',
                    visitors: 'Visiteur'
                }[result.type] || result.type;
                
                const item = result.item;
                const mainField = item.nom || item.nomOrganisation || item.nomContact || item.email || 'Sans nom';
                
                html += `
                    <div class="search-result-item" onclick="highlightSearchResult('${result.type}', ${result.index})">
                        <span class="result-type ${result.type}">${typeLabel}</span>
                        <strong>${highlightSearchTerm(mainField, searchTerm)}</strong>
                        <br>
                        <small>${item.email || item.telephone || item.ville || 'Pas de contact'}</small>
                    </div>
                `;
            });
            
            if (results.length > 10) {
                html += `<div class="search-result-item" style="text-align: center; color: #666;">... et ${results.length - 10} autres résultats</div>`;
            }
            
            resultsContainer.innerHTML = html;
            resultsContainer.style.display = 'block';
        }

        // Surligner le terme de recherche
        function highlightSearchTerm(text, searchTerm) {
            if (!text || !searchTerm) return text;
            const regex = new RegExp(`(${searchTerm})`, 'gi');
            return text.replace(regex, '<mark style="background: #ffeb3b; padding: 2px;">$1</mark>');
        }

        // Mettre en surbrillance un résultat de recherche
        function highlightSearchResult(type, index) {
            // Scroll vers la section correspondante
            const section = document.querySelector(`[data-section="${type}"]`);
            if (section) {
                section.scrollIntoView({ behavior: 'smooth' });
                section.style.background = '#fff3cd';
                setTimeout(() => {
                    section.style.background = '';
                }, 3000);
            }
            
            // Cacher les résultats de recherche
            document.getElementById('searchResults').style.display = 'none';
        }

        // Effacer la recherche
        function clearSearch() {
            document.getElementById('globalSearch').value = '';
            document.getElementById('searchResults').style.display = 'none';
        }

        // Afficher la vue carte
        function showMapView() {
            document.getElementById('visitorsData').parentElement.parentElement.style.display = 'none';
            document.getElementById('mapSection').style.display = 'block';
            
            // Générer les statistiques par pays pour la carte
            const data = currentData.visitors || [];
            const countryStats = {};
            data.forEach(visitor => {
                const country = visitor.country || 'Inconnu';
                countryStats[country] = (countryStats[country] || 0) + 1;
            });
            
            const sortedCountries = Object.entries(countryStats)
                .sort(([,a], [,b]) => b - a);
            
            let html = '<div class="geo-stats">';
            sortedCountries.forEach(([country, count]) => {
                const flag = getCountryFlag(country);
                html += `
                    <div class="geo-stat-item">
                        <div style="display: flex; align-items: center; justify-content: center; margin-bottom: 8px;">
                            ${flag ? `<img src="${flag}" class="country-flag" alt="${country}" style="margin-right: 8px;">` : ''}
                            <strong>${country}</strong>
                        </div>
                        <div class="geo-stat-number">${count}</div>
                        <div class="geo-stat-label">visiteur${count > 1 ? 's' : ''}</div>
                    </div>
                `;
            });
            html += '</div>';
            
            document.getElementById('countryStats').innerHTML = html;
        }

        // Masquer la vue carte
        function hideMapView() {
            document.getElementById('mapSection').style.display = 'none';
            document.getElementById('visitorsData').parentElement.parentElement.style.display = 'block';
        }
    </script>

    <style>
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            max-width: 400px;
            width: 90%;
            max-height: 90%;
            overflow-y: auto;
        }

        .login-container {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
        }

        .login-container h2 {
            color: #667eea;
            margin-bottom: 30px;
            font-size: 1.8rem;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 12px;
            border-radius: 8px;
            margin-top: 15px;
            border: 1px solid #f5c6cb;
        }

        .no-data {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        /* Styles pour la recherche */
        .search-section {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            overflow: hidden;
        }

        .search-container {
            padding: 20px;
        }

        .search-box {
            position: relative;
            margin-bottom: 15px;
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            z-index: 1;
        }

        .search-box input {
            width: 100%;
            padding: 15px 15px 15px 45px;
            border: 2px solid #e9ecef;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .search-box input:focus {
            outline: none;
            border-color: #667eea;
        }

        .search-filters {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .search-filters select {
            padding: 10px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 0.9rem;
            background: white;
        }

        .search-results {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: white;
            display: none;
        }

        .search-result-item {
            padding: 12px 15px;
            border-bottom: 1px solid #f1f3f4;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .search-result-item:hover {
            background-color: #f8f9fa;
        }

        .search-result-item:last-child {
            border-bottom: none;
        }

        .result-type {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-right: 8px;
        }

        .result-type.reservation {
            background: #e3f2fd;
            color: #1976d2;
        }

        .result-type.partenariat {
            background: #e8f5e8;
            color: #388e3c;
        }

        .result-type.contact {
            background: #fff3e0;
            color: #f57c00;
        }

        .result-type.newsletter {
            background: #fce4ec;
            color: #c2185b;
        }

        .result-type.visitor {
            background: #f3e5f5;
            color: #7b1fa2;
        }

        /* Styles pour la géolocalisation */
        .geo-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .geo-stat-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .geo-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #333;
        }

        .geo-stat-label {
            color: #666;
            font-size: 0.9rem;
        }

        .country-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .country-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }

        .country-item:last-child {
            border-bottom: none;
        }

        .country-flag {
            width: 24px;
            height: 16px;
            border-radius: 2px;
            margin-right: 10px;
        }

        .country-name {
            flex: 1;
            font-weight: 500;
        }

        .country-count {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
        }
    </style>
</body>
</html>
